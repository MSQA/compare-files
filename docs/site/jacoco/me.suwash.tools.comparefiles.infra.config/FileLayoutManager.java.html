<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FileLayoutManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Compare Files</a> &gt; <a href="index.source.html" class="el_package">me.suwash.tools.comparefiles.infra.config</a> &gt; <span class="el_source">FileLayoutManager.java</span></div><h1>FileLayoutManager.java</h1><pre class="source lang-java linenums">package me.suwash.tools.comparefiles.infra.config;

import java.io.File;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import me.suwash.tools.comparefiles.infra.Const;
import me.suwash.tools.comparefiles.infra.exception.CompareFilesException;
import me.suwash.util.CompareUtils.CompareCriteria;
import me.suwash.util.FileUtils;
import me.suwash.util.JsonUtils;

import org.apache.commons.lang3.StringUtils;

/**
 * ファイルレイアウト定義マネージャ。
 */
<span class="fc" id="L21">@lombok.extern.slf4j.Slf4j</span>
public final class FileLayoutManager {

    /** インスタンス。 */
<span class="fc" id="L25">    private static final FileLayoutManager instance = new FileLayoutManager();</span>

    /** ファイルレイアウト定義Map。 */
<span class="fc" id="L28">    private final Map&lt;String, FileLayout&gt; layoutMap = new TreeMap&lt;String, FileLayout&gt;();</span>

    /**
     * Singletonパターンでインスタンスを返します。
     *
     * @return インスタンス
     */
    public static FileLayoutManager getInstance() {
<span class="fc" id="L36">        return instance;</span>
    }

    /**
     * コンストラクタ。
     */
<span class="fc" id="L42">    private FileLayoutManager() {</span>
<span class="fc" id="L43">        addLayoutClasspath();</span>
<span class="fc" id="L44">    }</span>

    /**
     * クラスパスから、デフォルトのファイルレイアウト定義ファイルを登録します。
     */
    private void addLayoutClasspath() {
<span class="fc" id="L50">        log.debug(&quot;  ・addLayoutClasspath&quot;);</span>

        // 実行中のclasspath定義
<span class="fc" id="L53">        final String classpathes = System.getProperty(&quot;java.class.path&quot;);</span>
        // 環境ごとのclasspath区切り文字
<span class="fc" id="L55">        final String pathSeparator = System.getProperty(&quot;path.separator&quot;);</span>

        // classpathを全件ループ
<span class="fc bfc" id="L58" title="All 2 branches covered.">        for (final String curClasspath : classpathes.split(pathSeparator)) {</span>
            // 当該classpathがディレクトリの場合、含まれるレイアウト定義ファイルを全て登録
<span class="fc" id="L60">            addLayoutClasspath(curClasspath);</span>
        }
<span class="fc" id="L62">    }</span>

    /**
     * 指定クラスパス配下のレイアウト配置ディレクトリから、全てのレイアウトファイルを登録します。
     *
     * @param classpathStr クラスパス
     */
    private void addLayoutClasspath(final String classpathStr) {
        // サブディレクトリにFileLayout定義配置ディレクトリが存在するか確認
<span class="fc" id="L71">        final File classpath = new File(classpathStr);</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (classpath.isDirectory()) {</span>
<span class="fc" id="L73">            final File layoutDir = new File(classpath.getPath() + &quot;/&quot; + Const.CLASSPATH_LAYOUT_DIR_NAME);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">            if (layoutDir.exists()) {</span>
                // 存在する場合、配下の全てのファイルを定義追加
<span class="fc" id="L76">                addAllLayoutFile(layoutDir);</span>
            }
        }
<span class="fc" id="L79">    }</span>

    /**
     * 指定ディレクトリ配下にある全てのファイルを、ファイルレイアウト定義として上書き登録します。
     *
     * @param dirPath 対象のディレクトリパス
     */
    public void addLayoutDir(final String dirPath) {
<span class="nc" id="L87">        log.debug(&quot;  ・addLayoutDir(&quot; + dirPath + &quot;)&quot;);</span>

        // 入力チェック
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (StringUtils.isEmpty(dirPath)) {</span>
<span class="nc" id="L91">            throw new CompareFilesException(Const.CHECK_NOTNULL, new Object[] {&quot;dirPath&quot;});</span>
        }

        // ディレクトリ読み込みチェック
<span class="nc" id="L95">        FileUtils.readDirCheck(dirPath);</span>

        // 指定ディレクトリ配下の全てのファイルを定義追加
<span class="nc" id="L98">        final File dir = new File(dirPath);</span>
<span class="nc" id="L99">        addAllLayoutFile(dir);</span>
<span class="nc" id="L100">    }</span>

    /**
     * 指定ディレクトリ直下の全てのファイルをレイアウト登録します。
     *
     * @param dir 対象ディレクトリ
     */
    private void addAllLayoutFile(final File dir) {
<span class="fc" id="L108">        final File[] files = dir.listFiles();</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        if (files != null) {</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">            for (final File curFile : files) {</span>
<span class="fc" id="L111">                addLayoutFile(curFile.getPath());</span>
            }
        }
<span class="fc" id="L114">    }</span>

    /**
     * ファイルレイアウト定義ファイルを、上書き登録します。
     *
     * @param inputLayoutFilePath 対象のレイアウト定義ファイル
     */
    public void addLayoutFile(final String inputLayoutFilePath) {
<span class="fc" id="L122">        log.debug(&quot;  ・addLayoutFile(&quot; + inputLayoutFilePath + &quot;)&quot;);</span>

        // 入力チェック
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (StringUtils.isEmpty(inputLayoutFilePath)) {</span>
<span class="nc" id="L126">            throw new CompareFilesException(Const.CHECK_NOTNULL, new Object[] {&quot;inputLayoutFilePath&quot;});</span>
        }
        // ファイル読み込みチェック
<span class="fc" id="L129">        FileUtils.readCheck(inputLayoutFilePath, Const.CHARSET_DEFAULT_CONFIG);</span>

        // パース
<span class="fc" id="L132">        final File inputLayoutFile = new File(inputLayoutFilePath);</span>
<span class="fc" id="L133">        final FileLayoutList inputLayoutList = JsonUtils.parseFile(inputLayoutFile.getAbsolutePath(), Const.CHARSET_DEFAULT_CONFIG, FileLayoutList.class);</span>

        // 指定ファイルの定義内容をループ
<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (final FileLayout inputLayout : inputLayoutList.getLayoutList()) {</span>
            // 登録済み定義と一致する正規表現の場合、削除
<span class="fc" id="L138">            final String regex = inputLayout.getFileRegexPattern();</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">            if (layoutMap.containsKey(regex)) {</span>
<span class="nc" id="L140">                layoutMap.remove(regex);</span>
            }
            // 定義リストに追加
<span class="fc" id="L143">            log.trace(&quot;    ・[ADD]&quot; + inputLayout.getLogicalFileName());</span>
<span class="fc" id="L144">            layoutMap.put(regex, inputLayout);</span>
<span class="fc" id="L145">        }</span>
<span class="fc" id="L146">    }</span>

    /**
     * 物理ファイル名にマッチするファイルレイアウトを返します。
     * マッチするレイアウトが定義されていない場合、nullを返します。
     *
     * @param physicalFileName 物理ファイル名
     * @param systemConfig システム設定
     * @return マッチするファイルレイアウト
     */
    public FileLayout getLayout(final String physicalFileName, final CompareFilesConfig systemConfig) {
        // 返却用レイアウト定義
<span class="fc" id="L158">        FileLayout returnLayout = null;</span>

        // 定義リストを全件ループ
<span class="fc bfc" id="L161" title="All 2 branches covered.">        for (final Map.Entry&lt;String, FileLayout&gt; curLayoutEntry : layoutMap.entrySet()) {</span>
            // 定義の正規表現にマッチするか確認
            try {
<span class="fc" id="L164">                final Pattern pattern = Pattern.compile(curLayoutEntry.getKey());</span>
<span class="fc" id="L165">                final Matcher matcher = pattern.matcher(physicalFileName);</span>
<span class="fc" id="L166">                log.trace(&quot;        ・check regex:&quot; + curLayoutEntry.getKey());</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">                if (matcher.matches()) {</span>
                    // マッチした場合、返却用レイアウト定義に設定
<span class="fc" id="L169">                    log.info(&quot;      ・[MATCH  ]レイアウト:&quot; + curLayoutEntry.getValue().getLogicalFileName() + &quot;, 正規表現:&quot; + curLayoutEntry.getKey());</span>
<span class="fc" id="L170">                    returnLayout = curLayoutEntry.getValue();</span>
<span class="fc" id="L171">                    break;</span>
                }
<span class="nc" id="L173">            } catch (Exception e) {</span>
<span class="nc" id="L174">                log.error(&quot;正規表現の評価でエラーが発生しました。レイアウト:&quot; + curLayoutEntry.getValue().getLogicalFileName() + &quot;, 正規表現:&quot; + curLayoutEntry.getKey(), e);</span>
<span class="fc" id="L175">            }</span>
<span class="fc" id="L176">        }</span>

        // マッチしなかった場合、nullを返却
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (returnLayout == null) {</span>
<span class="fc" id="L180">            log.warn(&quot;      ・[UNMATCH]ファイル名:&quot; + physicalFileName);</span>
<span class="fc" id="L181">            return null;</span>
        }

        // systemConfigの存在確認
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (systemConfig != null) {</span>
            // 指定されている場合、返却用レイアウト定義に除外項目を適用
<span class="fc" id="L187">            updateIgnore(systemConfig, returnLayout);</span>
        }

        // 除外項目適用後の返却用レイアウト定義を返却
<span class="fc" id="L191">        return returnLayout;</span>
    }

    /**
     * システム設定の除外項目リストを、ファイルレイアウトオブジェクトに反映します。
     *
     * @param systemConfig システム設定
     * @param fileLayout ファイルレイアウト
     */
    private void updateIgnore(final CompareFilesConfig systemConfig, final FileLayout fileLayout) {
        // 除外項目リストを取得
<span class="fc" id="L202">        final List&lt;String&gt; ignoreItemList = systemConfig.getIgnoreItemList();</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        if (ignoreItemList == null) {</span>
            // 設定されていない場合、更新せずに終了
<span class="nc" id="L205">            return;</span>
        }

        // 返却用レイアウト定義の項目を全件ループ
<span class="fc bfc" id="L209" title="All 2 branches covered.">        for (final RecordLayout curRecordLayout : fileLayout.getRecordList()) {</span>
<span class="fc bfc" id="L210" title="All 2 branches covered.">            for (final ItemLayout curItemLayout : curRecordLayout.getItemList()) {</span>
                // 一致する場合、criteriaを除外に設定
<span class="fc bfc" id="L212" title="All 2 branches covered.">                if (isIgnoreItem(ignoreItemList, curItemLayout)) {</span>
<span class="fc" id="L213">                    curItemLayout.setCriteria(CompareCriteria.Ignore);</span>
                }
<span class="fc" id="L215">            }</span>
<span class="fc" id="L216">        }</span>
<span class="fc" id="L217">    }</span>

    /**
     * 指定項目が、除外対象か否かを返します。
     *
     * @param ignoreItemList 除外項目リスト
     * @param itemLayout 対象項目レイアウト
     * @return 除外対象の場合、true
     */
    private boolean isIgnoreItem(final List&lt;String&gt; ignoreItemList, final ItemLayout itemLayout) {
<span class="fc" id="L227">        boolean isIgnore = false;</span>
        // 除外項目リストをループ
<span class="fc bfc" id="L229" title="All 2 branches covered.">        for (final String ignoreItemName : ignoreItemList) {</span>
            // 項目名の一致を確認
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if (ignoreItemName.equals(itemLayout.getId())) {</span>
<span class="fc" id="L232">                isIgnore = true;</span>
<span class="fc" id="L233">                break;</span>
            }
<span class="fc" id="L235">        }</span>
<span class="fc" id="L236">        return isIgnore;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>